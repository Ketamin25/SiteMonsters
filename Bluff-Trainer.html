<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nitro Bluff Trainer</title>
<style>
  :root{
    --bg:#0a0a0c; --panel:#1a1a1f; --panel2:#111114; --text:#f1f5f9;
    --muted:#9aa4b2; --red:#e4002b; --green:#34d399; --amber:#f59e0b; --border:#2a2a32;
  }
  body{margin:0;background:var(--bg);color:var(--text);font:18px/1.5 system-ui}
  .container{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
  h1{font-size:28px;margin:0}
  .controls{display:flex;gap:10px;align-items:center}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);cursor:pointer}
  .btn.primary{background:var(--red);color:#fff;border:none}
  .btn.ghost{background:var(--panel);color:var(--text)}
  .btn.small{padding:8px 10px;border-radius:8px}
  input, select{padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--panel2);color:var(--text)}
  .hidden{display:none}
  .settings-panel{background:var(--panel);padding:16px;margin-top:10px;border-radius:10px}
  .settings-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .frame{border:2px solid var(--border);border-radius:10px;padding:12px 16px;text-align:center;font-size:26px;font-weight:800}
  .frames{display:flex;gap:18px;justify-content:center;margin-top:18px}
  .question{text-align:center;font-size:28px;margin:26px 0 14px}
  .answer-box{text-align:center}
  #answer{font-size:30px;padding:12px;width:220px;text-align:center;border-radius:10px;border:2px solid var(--border);background:var(--panel2);color:var(--text)}
  .feedback{text-align:center;margin-top:12px;font-size:20px}
  table{width:100%;margin-top:22px;border-collapse:collapse}
  th, td{border:1px solid var(--border);padding:8px 10px;text-align:center}
  th{background:var(--panel)}
  .timer-wrap{display:flex;gap:8px;align-items:center}
  .timer{font-weight:800;font-size:22px;min-width:70px;text-align:right}
  .hint{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Nitro Bluff Trainer</h1>

    <!-- Панель справа: режим + таймер -->
    <div class="controls">
      <label class="hint">Режим:</label>
      <select id="mode">
        <option value="sbb" selected>SBB (кепка 30bb)</option>
        <option value="hu">HU (кепка 40bb)</option>
      </select>

      <div class="timer-wrap">
        <input id="timeInput" type="number" min="5" step="5" value="60" title="Время, сек" />
        <span class="timer" id="timer">—</span>
        <button class="btn small ghost" id="pauseBtn" disabled>Пауза</button>
        <button class="btn small" id="stopBtn" disabled>Стоп</button>
      </div>
    </div>
  </header>

  <button class="btn ghost" id="toggleSettings">Доп. настройки ▼</button>
  <div class="settings-panel hidden" id="settings">
    <div class="settings-grid">
      <div><label class="hint">Min Pot</label><input id="minPot" type="number" value="2" step="0.5"></div>
      <div><label class="hint">Max Pot</label><input id="maxPot" type="number" value="20" step="0.5"></div>
      <div><label class="hint">Min Bet</label><input id="minBet" type="number" value="1" step="0.5"></div>
      <div><label class="hint">Max Bet</label><input id="maxBet" type="number" value="20" step="0.5"></div>
      <div><label class="hint">Min Stack</label><input id="minStack" type="number" value="2" step="0.5"></div>
      <div><label class="hint">Max Stack</label><input id="maxStack" type="number" value="20" step="0.5"></div>
      <div><label class="hint">Шаг генерации</label>
        <select id="step">
          <option value="1">1 bb</option>
          <option value="0.5" selected>0.5 bb</option>
          <option value="0.3333333333">1/3 bb (~0.33)</option>
          <option value="0.01">Сотые (0.01) — только один параметр</option>
        </select>
      </div>
    </div>
  </div>

  <div class="frames">
    <div class="frame" id="potBox">Pot: —</div>
    <div class="frame" id="betBox">Bet: —</div>
    <div class="frame" id="stackBox">Stack: —</div>
  </div>

  <div class="question">Количество блефов для нулевого колла?</div>

  <div class="answer-box">
    <input id="answer" type="number" step="0.01" placeholder="%">
    <div class="feedback" id="feedback"></div>
  </div>

  <div style="text-align:center;margin-top:16px">
    <button class="btn primary" id="start">Старт</button>
    <button class="btn ghost" id="check" disabled>Проверить (Enter)</button>
    <button class="btn" id="next" disabled>След. спот (Пробел)</button>
  </div>

  <div style="text-align:center;margin-top:12px">
    <button class="btn ghost" id="showFormula">Показать формулу</button>
    <div id="formula" class="hidden" style="margin-top:10px;background:var(--panel);padding:12px;border-radius:10px">
      Необходимые блефы (%) = <b>Колл / (Пот + эффективная ставка + Колл) × 100</b>, где
      <b>эффективная ставка = min(Ставка оппонента, Наш стек)</b>.
    </div>
  </div>

  <table>
    <thead>
      <tr><th>Время</th><th>Pot</th><th>Bet</th><th>Stack</th><th>Цель %</th><th>Ответ %</th><th>Верно</th></tr>
    </thead>
    <tbody id="history"></tbody>
  </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = id => document.getElementById(id);
  const fmt = (n,d=2)=> isFinite(n)? Number(n.toFixed(d)).toLocaleString() : "—";
  const now = ()=> new Date().toLocaleTimeString();

  // elements
  const mode=$('mode'), timeInput=$('timeInput'), timerEl=$('timer'), pauseBtn=$('pauseBtn'), stopBtn=$('stopBtn');
  const toggleSettings=$('toggleSettings'), settings=$('settings'), showFormula=$('showFormula'), formula=$('formula');
  const minPot=$('minPot'), maxPot=$('maxPot'), minBet=$('minBet'), maxBet=$('maxBet');
  const minStack=$('minStack'), maxStack=$('maxStack'), stepEl=$('step');
  const potBox=$('potBox'), betBox=$('betBox'), stackBox=$('stackBox');
  const answer=$('answer'), feedback=$('feedback'), historyBody=$('history');
  const startBtn=$('start'), checkBtn=$('check'), nextBtn=$('next');

  // state
  let started=false, paused=false, timerId=null, timeLeft=0;
  let current={pot:0,bet:0,stack:0,target:0};

  // UI toggles
  toggleSettings.addEventListener('click', ()=> settings.classList.toggle('hidden'));
  showFormula.addEventListener('click', ()=> formula.classList.toggle('hidden'));
  timeInput.addEventListener('change', ()=> { if(!started){ timerEl.textContent = (+timeInput.value||0)+'s'; }});

  // random with step
  function randStep(min,max,step){
    if(min>max)[min,max]=[max,min];
    const count = Math.floor((max-min)/step)+1;
    const k = Math.floor(Math.random()*Math.max(1,count));
    return +(min + step*k).toFixed(2);
  }

  function genTask(){
    const cap = mode.value==='sbb'?30:40;
    const pMin=+minPot.value, pMax=+maxPot.value;
    const bMin=+minBet.value, bMax=+maxBet.value;
    const sMin=+minStack.value, sMax=+maxStack.value;
    const step=+stepEl.value;

    let pot, bet, stack;
    if(step===0.01){
      const which = Math.floor(Math.random()*3); // один параметр с сотыми
      const half = 0.5;
      if(which===0){ pot=randStep(pMin,pMax,0.01); bet=randStep(bMin,bMax,half); stack=randStep(sMin,sMax,half); }
      else if(which===1){ pot=randStep(pMin,pMax,half); bet=randStep(bMin,bMax,0.01); stack=randStep(sMin,sMax,half); }
      else { pot=randStep(pMin,pMax,half); bet=randStep(bMin,bMax,half); stack=randStep(sMin,sMax,0.01); }
    } else {
      pot=randStep(pMin,pMax,step);
      bet=randStep(bMin,bMax,step);
      stack=randStep(sMin,sMax,step);
    }

    // кепка: pot + 2*bet <= cap
    const stepForBet = (step===0.01)? (bet.toString().includes('.') && bet.toString().split('.')[1].length>2 ? 0.01 : 0.5) : step;
    const maxHalf = Math.max(0,(cap - pot)/2);
    if(bet > maxHalf){
      const k = Math.floor(maxHalf/stepForBet);
      bet = +(k*stepForBet).toFixed(2);
    }

    const effBet = Math.min(bet, stack);
    const call = effBet;
    const target = +((call)/(pot+effBet+call)*100).toFixed(2);

    current={pot,bet,stack,target};
    potBox.textContent=`Pot: ${fmt(pot,2)}b`;
    betBox.textContent=`Bet: ${fmt(bet,2)}b`;
    stackBox.textContent=`Stack: ${fmt(stack,2)}b`;
    answer.value=''; feedback.textContent=''; answer.focus();
  }

  function start(){
    started=true; paused=false;
    timeLeft = Math.max(1, +timeInput.value || 60);
    timerEl.textContent = timeLeft+'s';
    if(timerId) clearInterval(timerId);
    timerId = setInterval(()=>{
      if(!started || paused) return;
      if(timeLeft>0){ timeLeft--; timerEl.textContent=timeLeft+'s'; }
      else { clearInterval(timerId); timerId=null; }
    }, 1000);

    genTask();
    checkBtn.disabled=false; nextBtn.disabled=false;
    pauseBtn.disabled=false; stopBtn.disabled=false;
    pauseBtn.textContent='Пауза';
  }

  function pauseResume(){
    if(!started) return;
    paused = !paused;
    pauseBtn.textContent = paused ? 'Продолжить' : 'Пауза';
  }

  function stop(){
    started=false; paused=false;
    if(timerId){ clearInterval(timerId); timerId=null; }
    timerEl.textContent='—';
    checkBtn.disabled=true; nextBtn.disabled=true;
    pauseBtn.disabled=true; stopBtn.disabled=true;
    feedback.textContent='';
    potBox.textContent='Pot: —'; betBox.textContent='Bet: —'; stackBox.textContent='Stack: —';
    answer.value='';
  }

  function check(){
    if(!started) return;
    const ans=+answer.value;
    if(isNaN(ans)) return;
    const ok = Math.abs(ans - current.target) <= 1; // допуск ±1%
    feedback.textContent = ok? 'Верно!' : `Неверно, верно: ${current.target}%`;
    feedback.style.color = ok? 'var(--green)' : 'var(--amber)';

    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${now()}</td><td>${current.pot}</td><td>${current.bet}</td><td>${current.stack}</td><td>${current.target}</td><td>${ans}</td><td>${ok?'Да':'Нет'}</td>`;
    historyBody.prepend(tr);
  }

  function next(){
    if(!started) return;
    genTask();
  }

  // bind
  startBtn.addEventListener('click', start);
  checkBtn.addEventListener('click', check);
  nextBtn.addEventListener('click', next);
  pauseBtn.addEventListener('click', pauseResume);
  stopBtn.addEventListener('click', stop);

  window.addEventListener('keydown', (e)=>{
    if(e.key==='Enter') check();
    if(e.code==='Space'){ e.preventDefault(); next(); }
    if(e.key.toLowerCase()==='p'){ e.preventDefault(); pauseResume(); }
  });

  // init timer display
  timerEl.textContent = (+timeInput.value||0)+'s';
});
</script>
</body>
</html>
